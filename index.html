<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ—©å®‰åœ–ç”Ÿæˆå™¨ï¼ˆæ—¥æœŸï¼‹åŸå¸‚å¤©æ°£ï¼‹é‡‘å¥ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
      font-size: 22px;
    }
    h2 {
      font-size: 32px;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 20px;
      max-width: 100%;
    }
    button, select, input {
      margin: 8px;
      font-size: 20px;
      padding: 6px 12px;
      border-radius: 6px;
    }
    button {
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    button:hover {
      background-color: #45a049;
    }
    #outputImage {
      margin-top: 20px;
      max-width: 100%;
      border: 1px solid #ccc;
      font-size: 24px;
    }
    #controlPanel {
      display: inline-block;
      text-align: left;
      margin: 20px auto;
      padding: 15px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background: #fff;
    }
    #controlPanel h3 {
      margin: 10px 0 5px;
      font-size: 24px;
      color: #333;
    }
    #topSizeDisplay, #bottomSizeDisplay,
    #topOffsetDisplay, #bottomOffsetDisplay {
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>ğŸŒ… æ—©å®‰åœ–ç”Ÿæˆå™¨ï¼ˆæ—¥æœŸï¼‹åŸå¸‚å¤©æ°£ï¼‹é‡‘å¥ç‰ˆï¼‰</h2>
  <input type="file" id="upload" accept="image/*"><br>
  
  <select id="city">
    <option value="è‡ºåŒ—å¸‚" selected>è‡ºåŒ—å¸‚</option>
    <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
    <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
    <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
    <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
    <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
    <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
    <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
    <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
    <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option>
  </select>
  
  <br>
  ä¸Šæ’æ–‡å­—ï¼š<input type="text" id="topText" value="è¦ªå‹å€‘ï¼Œæ—©å®‰ï¼"><br>
  ä¸‹æ’é‡‘å¥ï¼š<input type="text" id="customQuote" placeholder="è¼¸å…¥é‡‘å¥ï¼Œç•™ç©ºå‰‡éš¨æ©Ÿ"><br>
  <!-- æ§åˆ¶é¢æ¿ -->
  <div id="controlPanel">
    <h3>ä¸Šæ’æ–‡å­—æ§åˆ¶</h3>
    å­—å¤§å°ï¼š
    <button onclick="adjustSize('top', -0.01)">ï¼</button>
    <span id="topSizeDisplay">0.08</span>
    <button onclick="adjustSize('top', 0.01)">ï¼‹</button>
    <br>
    ä½ç½®ï¼š
    <button onclick="adjustPosition('top', -0.02)">ä¸Šç§»</button>
    <span id="topOffsetDisplay">0.00</span>
    <button onclick="adjustPosition('top', 0.02)">ä¸‹ç§»</button>
    
    <h3>ä¸‹æ’æ–‡å­—æ§åˆ¶</h3>
    å­—å¤§å°ï¼š
    <button onclick="adjustSize('bottom', -0.01)">ï¼</button>
    <span id="bottomSizeDisplay">0.04</span>
    <button onclick="adjustSize('bottom', 0.01)">ï¼‹</button>
    <br>
    ä½ç½®ï¼š
    <button onclick="adjustPosition('bottom', -0.02)">ä¸Šç§»</button>
    <span id="bottomOffsetDisplay">0.00</span>
    <button onclick="adjustPosition('bottom', 0.02)">ä¸‹ç§»</button>
  </div>
  
  <button onclick="changeColor()">æ–‡å­—é¡è‰²</button>
  <button onclick="showImage()">æ’ç‰ˆç¢ºèª</button>
  
  <br>
  <canvas id="canvas"></canvas>
  <br>
  <img id="outputImage" alt="ç”Ÿæˆçš„åœ–ç‰‡å°‡é¡¯ç¤ºåœ¨é€™è£¡">
<script>
  let topSize = 0.08;
  let bottomSize = 0.04;
  let topOffset = 0;
  let bottomOffset = 0;
  let style = { fill: "black", stroke: "white" };

  function adjustSize(target, delta) {
    if (target === 'top') {
      topSize = Math.max(0.01, topSize + delta);
      document.getElementById("topSizeDisplay").innerText = topSize.toFixed(2);
    } else {
      bottomSize = Math.max(0.01, bottomSize + delta);
      document.getElementById("bottomSizeDisplay").innerText = bottomSize.toFixed(2);
    }
    generate();
  }

  function adjustPosition(target, delta) {
    if (target === 'top') {
      topOffset += delta;
      document.getElementById("topOffsetDisplay").innerText = topOffset.toFixed(2);
    } else {
      bottomOffset += delta;
      document.getElementById("bottomOffsetDisplay").innerText = bottomOffset.toFixed(2);
    }
    generate();
  }

  function changeColor() {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 256);
    style = { fill: `rgb(${r},${g},${b})`, stroke: "white" };
    generate();
  }

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let img = new Image();
  img.crossOrigin = "anonymous";

  const boringQuotes = [
    "ä»Šå¤©çš„æˆ‘ï¼Œå·²ç¶“ä¸å†æ˜¯æ˜¨å¤©çš„æˆ‘ã€‚",
    "èººå¹³é‚„åœ¨å‘¼å¸ä¹Ÿæ˜¯ä¸€ç¨®ç”Ÿæ´»æ–¹å¼ã€‚",
    "äº‹æƒ…ä¸å¤šï¼Œä½†æ™‚é–“ç”¨åœ¨ç™¼å‘†ã€‚",
    "æœ›è‘—å¤©èŠ±æ¿ï¼Œæ€è€ƒäººç”Ÿçš„æ„ç¾©ã€‚",
    "å’–å•¡å–å®Œäº†ï¼Œç„¡èŠé‚„æ²’æ‰“ç®—èµ°ã€‚",
    "æ»‘æ‰‹æ©Ÿæ»‘åˆ°æ‰‹æŒ‡ç ´çš®ã€‚",
    "ä»Šå¤©çš„æ–°èéƒ½æ˜¯éå»çš„äº‹ã€‚",
    "å¤§è²å•å€™ç„¡äººå³¶çš„å„ä½ã€‚",
    "æƒ³è·Ÿè‡ªå·±å°è©±å»æƒ³èµ·é‚„åœ¨å†·æˆ°ã€‚",
    "ä¸Šæ¬¡æ”¶åˆ°ç”Ÿæ—¥ç¦®ç‰©å·²ç¶“éä¸€å¹´ã€‚",
    "æ‰‹æ©Ÿé—œéœéŸ³å¾Œç™¼ç¾æ•´å¤©æ²’äººæ‰¾æˆ‘ã€‚",
    "ç„¡èŠæ˜¯ä¸€ç¨®å¹³å‡¡çš„æµªæ¼«ã€‚",
    "ä»Šå¤©çš„äº®é»ï¼šæ²’æœ‰äº®é»ã€‚",
    "ç„¡èŠåˆ°é–‹å§‹æ•¸è‡ªå·±æ‰“äº†å¹¾æ¬¡å“ˆæ¬ ã€‚"
  ];

  function getRandomQuote() {
    const index = Math.floor(Math.random() * boringQuotes.length);
    return boringQuotes[index];
  }

  window.onload = function() {
    img.src = "IMG_5776.jpeg"; 
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      generate(); 
    };
  };

  document.getElementById("upload").addEventListener("change", function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
      img.src = event.target.result;
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        generate();
      };
    };
    reader.readAsDataURL(e.target.files[0]);
  });

  function drawTextWithStroke(text, x, y, fontSizeRatio, style) {
    const fontSize = Math.round(canvas.height * fontSizeRatio);
    ctx.font = `bold ${fontSize}px sans-serif`;
    ctx.textAlign = "center";
    ctx.lineWidth = Math.max(2, fontSize / 15);
    ctx.strokeStyle = style.stroke;
    ctx.fillStyle = style.fill;
    ctx.strokeText(text, x, y);
    ctx.fillText(text, x, y);
  }

  function getDateInfo() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
    const weekStr = ["æ˜ŸæœŸæ—¥","æ˜ŸæœŸä¸€","æ˜ŸæœŸäºŒ","æ˜ŸæœŸä¸‰","æ˜ŸæœŸå››","æ˜ŸæœŸäº”","æ˜ŸæœŸå…­"][today.getDay()];

    // è¾²æ›†æ—¥æœŸ
    const lunarFormatter = new Intl.DateTimeFormat("zh-TW-u-ca-chinese", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });
    const lunarStr = lunarFormatter.format(today);

    return {
      solar: `${dateStr} ${weekStr}`,
      lunar: `è¾²æ›† ${lunarStr}`
    };
  }

  async function getWeather(city) {
    try {
      const response = await fetch("https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWA-A6F3874E-27F3-4AA3-AF5A-96B365798F79&format=JSON");
      const data = await response.json();
      const location = data.records.location.find(loc => loc.locationName === city);
      if (location) {
        const wx = location.weatherElement.find(el => el.elementName === "Wx").time[0].parameter.parameterName;
        const minT = location.weatherElement.find(el => el.elementName === "MinT").time[0].parameter.parameterName;
        const maxT = location.weatherElement.find(el => el.elementName === "MaxT").time[0].parameter.parameterName;
        return `${city}ï¼š${wx}ï¼Œ${minT}~${maxT}â„ƒ`;
      }
      return `${city}ï¼šå¤©æ°£è³‡æ–™å–å¾—å¤±æ•—`;
    } catch {
      return `${city}ï¼šå¤©æ°£è³‡æ–™å–å¾—å¤±æ•—`;
    }
  }

  async function generate() {
    if (!img.src) return;
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    const city = document.getElementById("city").value;
    const dateInfo = getDateInfo();
    const weatherInfo = await getWeather(city);

    const customQuote = document.getElementById("customQuote").value.trim();
    const quote = customQuote || getRandomQuote();
    const topText = document.getElementById("topText").value.trim() || "è¦ªå‹å€‘ï¼Œæ—©å®‰ï¼";

    // ä¸Šæ’æ–‡å­—
    drawTextWithStroke(topText, canvas.width / 2, canvas.height * (0.15 + topOffset), topSize, style);

    // ä¸‹æ’å››è¡Œï¼šè¥¿æ›†ï¼‹æ˜ŸæœŸã€è¾²æ›†ã€å¤©æ°£ã€é‡‘å¥
    const lines = [
      `ğŸ“… ${dateInfo.solar}`,
      `ğŸŒ™ ${dateInfo.lunar}`,
      `â˜€ï¸ ${weatherInfo}`,
      `ğŸ’¡ ${quote}`
    ];
    lines.forEach((line, i) => {
      drawTextWithStroke(line, canvas.width / 2, canvas.height * (0.75 + bottomOffset) + i * canvas.height * 0.06, bottomSize, style);
    });
  }

  function showImage() {
    const imageURL = canvas.toDataURL("image/png");
    document.getElementById("outputImage").src = imageURL;
  }
</script>

</body>
</html>
